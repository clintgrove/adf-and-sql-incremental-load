parameters:
  ServiceConnection: string
  SubscriptionId: string
  ResourceGroupName: string
  Location: string
  TemplateFilePath: string
  TemplateParamFilePath: string
  ServiceReleased: string
  sqlServerPasswordDA: string
  doSql: false 
  

steps:

- ${{ if eq(parameters.doSql, 'true') }}:
  - task: AzureResourceManagerTemplateDeployment@3
    #condition: and(succeed(), eq('${{parameters.doSql}}', 'true'))
    displayName: "Create ${{ parameters.ServiceReleased}}"
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: ${{ parameters.ServiceConnection }}
      subscriptionId: ${{ parameters.SubscriptionId }}
      action: 'Create Or Update Resource Group'
      resourceGroupName: ${{ parameters.ResourceGroupName }}
      location: ${{ parameters.Location }}
      templateLocation: 'Linked artifact'
      csmFile: ${{ parameters.TemplateFilePath }}
      csmParametersFile: ${{ parameters.TemplateParamFilePath }}
      deploymentMode: 'Incremental'
      overrideParameters: '-administratorLoginPassword ${{parameters.sqlServerPasswordDA}}'
      outputs: armOutput


- ${{ if eq(parameters.doSql, 'false') }}:
  - task: AzureResourceManagerTemplateDeployment@3
    #condition: and(succeed(), eq('${{parameters.doSql}}', 'true')) #this is for the datafactory deployment
    displayName: "Create ${{ parameters.ServiceReleased}}"
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: ${{ parameters.ServiceConnection }}
      subscriptionId: ${{ parameters.SubscriptionId }}
      action: 'Create Or Update Resource Group'
      resourceGroupName: ${{ parameters.ResourceGroupName }}
      location: ${{ parameters.Location }}
      templateLocation: 'Linked artifact'
      csmFile: ${{ parameters.TemplateFilePath }}
      csmParametersFile: ${{ parameters.TemplateParamFilePath }}
      deploymentMode: 'Incremental'

- ${{ if and(eq(parameters.doSql, 'false'), eq(parameters.ServiceReleased, 'Azure Data Factory')) }}:

  - task: AzurePowerShell@5
    displayName: Get output from ARM template for ADF deployment
    name: SetSqlVarFQDNp1
    inputs:
      script: FilePath
      azureSubscription: '$(ServiceConnection)'
      ScriptPath: '$(Pipeline.Workspace)/Scripts/getDeploymentOutputs.ps1'
      ScriptArguments: '-resourceGroupName ${{variables.ResourceGroupNameGHUB}}'
      azurePowerShellVersion: LatestVersion
      
  - script: echo sqlSrvNameOutput is  with alias  $(SetSqlVarFQDNp1.sqlSrvNameOutput)

  - task: AzureResourceManagerTemplateDeployment@3
    #condition: and(succeed(), eq('${{parameters.doSql}}', 'true')) #this is for the datafactory deployment
    displayName: "Create ${{ parameters.ServiceReleased}}"
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: ${{ parameters.ServiceConnection }}
      subscriptionId: ${{ parameters.SubscriptionId }}
      action: 'Create Or Update Resource Group'
      resourceGroupName: ${{ parameters.ResourceGroupName }}
      location: ${{ parameters.Location }}
      templateLocation: 'Linked artifact'
      csmFile: ${{ parameters.TemplateFilePath }}
      csmParametersFile: ${{ parameters.TemplateParamFilePath }}
      deploymentMode: 'Incremental'
      overrideParameters: '-factstuff_linkedServSource_connectionString "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=$(SetSqlVarFQDNp1.sqlSrvNameOutput);Initial Catalog=dba-fac-stf-source;Server=tcp:$(SetSqlVarFQDNp1.sqlSrvNameOutput),1433;TrustServerCertificate=False"'
      outputs: adfNameOutput